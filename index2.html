<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Wat Tham Chetawan - Kruba Noi Yanwichai</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body { margin:0; padding:0; height:500vh; overflow-x:hidden; background:#000; }
  video {
    position:fixed; 
    top:0; left:0;
    width:100vw; height:100vh;
    min-width:100vw; min-height:100vh;
    object-fit:cover; 
    z-index:10; pointer-events:none;
    opacity:0;
    transition: opacity 0.5s;
  }
  video.loaded {
    opacity:1;
  }
</style>
</head>
<body>

<img id="placeholder" src="front.jpeg" alt="Loading" 
     class="fixed top-0 left-0 w-full h-full object-cover z-5" />

<video id="bg" preload="auto" muted playsinline muted autoplay loop preload="auto"
  controlslist="nodownload noplaybackrate" disablepictureinpicture>
  <source src="output.mp4"  type="video/mp4">
  <source src="output.webm" type="video/webm">
</video>


<img src="banner_tr.png" alt="Wat Tham Chetawan Banner"
  class="fixed top-5 left-1/2 -translate-x-1/2 z-30 opacity-90 pointer-events-none
         w-full max-w-[420px]" />
<div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 text-center text-white">
  <p class="text-2xl font-bold mb-2">Kruba Noi Yanwichai</p>
  <p class="text-xl mb-2">30-08-2023</p>
  <p class="text-xl">Wat Tham Chetawan</p>
</div>
<img src="kubanoi_tr.png" alt="Kruba Noi"
  class="fixed bottom-0 left-1/2 -translate-x-1/2 z-30 pointer-events-none
         w-[60vw] max-w-[420px]  h-auto" />

<script>
  const video = document.getElementById('bg');
  let target = 0, duration = 0, docH = 0, ticking = false;

  const updateDocH = () => {
    docH = document.documentElement.scrollHeight - window.innerHeight;
  };

  const onScroll = () => {
    if (duration === 0) return; // Non fare nulla se il video non è caricato
    const frac = docH > 0 ? window.scrollY / docH : 0;
    target = duration * Math.min(Math.max(frac, 0), 1);
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(applyTime);
    }
  };

  const applyTime = () => {
    ticking = false;
    // Applica solo se differenza > 1 frame (~0.04s a 24fps) e il video è pronto
    if (video.readyState >= 2 && Math.abs(video.currentTime - target) > 0.04) {
      try {
        video.currentTime = target;
      } catch (e) {
        // Ignora errori su iOS
      }
    }
  };

  // Debug: forza la visualizzazione del video
  const forceVideoDisplay = () => {
    console.log('Forcing video display');
    video.style.opacity = '1';
    video.style.zIndex = '10';
    document.getElementById('placeholder').style.display = 'none';
  };
  
  video.addEventListener('loadedmetadata', () => {
    duration = video.duration || 0;
    video.pause();
    console.log('Video loaded:', video.currentSrc, 'Duration:', duration);
    console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
    
    updateDocH();
    onScroll();
    
    // Forza la visualizzazione dopo un piccolo delay
    setTimeout(forceVideoDisplay, 100);
  });

  video.addEventListener('error', (e) => {
    console.log('Video error:', e);
  });

  // Fallback - forza visualizzazione dopo 2 secondi
  setTimeout(() => {
    console.log('Fallback triggered');
    duration = video.duration || 10;
    updateDocH();
    onScroll();
    forceVideoDisplay();
  }, 2000);

  // Fix per iOS: forza il video a rimanere in pausa
  video.addEventListener('play', () => {
    video.pause();
  });

  // Listener "passive" e ricalcolo su resize
  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', () => {
    updateDocH();
    onScroll();
  }, { passive: true });
</script>

</body>
</html>
